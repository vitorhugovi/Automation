import re
import unicodedata


def clean_str(value):
    if value is None:
        return ""
    text = str(value).replace('"', "").strip()
    text = re.sub(r"\s+", " ", text)
    return text


def normalize_name(value):
    text = clean_str(value).lower()
    text = "".join(
        ch
        for ch in unicodedata.normalize("NFKD", text)
        if not unicodedata.combining(ch)
    )
    text = re.sub(r"[^a-z0-9 ]+", "", text)
    text = re.sub(r"\s+", " ", text).strip()
    return text


MAP = {
    "lucas rodrigues ferreira": "USFSS2CEP",
    "thais rodrigues dos santos": "U013CHXF93R",
}
MAP_NORM = {normalize_name(k): v for k, v in MAP.items() if normalize_name(k)}

out = []
missing_tls = set()

for it in items:
    data = it.get("json", {})
    if not isinstance(data, dict):
        continue

    existing_uid = clean_str(data.get("slack_user_id"))
    if existing_uid:
        data["slack_user_id"] = existing_uid
        out.append(it)
        continue

    tl_raw = data.get("TL") or data.get("tl") or ""
    tl_clean = clean_str(tl_raw)
    tl_norm = normalize_name(tl_clean)

    uid = MAP_NORM.get(tl_norm)
    if not uid:
        missing_tls.add(tl_clean or "Sem TL")
        continue

    data["slack_user_id"] = uid
    it["json"] = data
    out.append(it)

if missing_tls:
    print("TLs sem mapeamento:", ", ".join(sorted(missing_tls)))

return out